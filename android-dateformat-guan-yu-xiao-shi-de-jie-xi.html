<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>Android DateFormat 关于小时的解析</title>
        <link rel="stylesheet" href="http://seven332.github.io/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://seven332.github.io/">Hippo's Blog </a></h1>
                <nav><ul>
                    <li class="active"><a href="http://seven332.github.io/category/android.html">Android</a></li>
                    <li><a href="http://seven332.github.io/category/wu.html">无</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://seven332.github.io/android-dateformat-guan-yu-xiao-shi-de-jie-xi.html" rel="bookmark"
           title="Permalink to Android DateFormat 关于小时的解析">Android DateFormat 关于小时的解析</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-09-29T15:00:00+08:00">
                发表于：15-09-29 15 Tue
        </abbr>

        <p>
                作者：                        <a class="url fn" href="http://seven332.github.io/author/hippo.html">Hippo</a>
        </p>
<p>分类： <a href="http://seven332.github.io/category/android.html">Android</a></p>

</footer><!-- /.post-info -->      <p>这是以前写的文章。</p>
<p>这是以前遇到的问题，具体可以在<a href="https://github.com/seven332/EhViewer/issues/16">这里</a>看到。今天不想做别的事所以又研究了下。</p>
<p>我本来是想弄个显示时间的控件，记得 Android 本身就有个 TextClock 就直接拿过来用了。结果这个是 JELLY_BEAN_MR1（API 17） 的时候加入的。为了兼容旧的 Android 本版，我直接把 TextClock 的代码拷贝了一份修改了下就能用了。</p>
<p>后来有看到别人发的截图，时间显示的是 HH:什么什么。我当时没有注意。后来有人发个了 issue，我才开始注意这个问题。</p>
<p>JELLY_BEAN_MR1（API 17） TextClock 默认解析格式是</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CharSequence</span> <span class="n">DEFAULT_FORMAT_12_HOUR</span> <span class="o">=</span> <span class="s">&quot;h:mm aa&quot;</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CharSequence</span> <span class="n">DEFAULT_FORMAT_24_HOUR</span> <span class="o">=</span> <span class="s">&quot;k:mm&quot;</span><span class="o">;</span>
</pre></div>


<p>JELLY_BEAN_MR2（API 18） TextClock 默认解析格式是</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CharSequence</span> <span class="n">DEFAULT_FORMAT_12_HOUR</span> <span class="o">=</span> <span class="s">&quot;h:mm a&quot;</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CharSequence</span> <span class="n">DEFAULT_FORMAT_24_HOUR</span> <span class="o">=</span> <span class="s">&quot;H:mm&quot;</span><span class="o">;</span>
</pre></div>


<p>可以看出来问题是出在 k 与 H 之间，低版本无法解析 H。</p>
<p>具体的解析工作是由 <code>android.text.format.DateFormat</code> 完成的。主要函数为 <code>public static CharSequence format(CharSequence inFormat, Calendar inDate)</code>。</p>
<p>JELLY_BEAN_MR1（API 17） 相关片段（注释是我自己加的）</p>
<div class="highlight"><pre>                <span class="k">case</span> <span class="n">HOUR</span><span class="o">:</span> <span class="c1">// &#39;h&#39;</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">inDate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">HOUR</span><span class="o">);</span>

                    <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">temp</span><span class="o">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>

                    <span class="n">replacement</span> <span class="o">=</span> <span class="n">zeroPad</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>

                <span class="k">case</span> <span class="n">HOUR_OF_DAY</span><span class="o">:</span> <span class="c1">// &#39;k&#39;</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="n">zeroPad</span><span class="o">(</span><span class="n">inDate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">HOUR_OF_DAY</span><span class="o">),</span> <span class="n">count</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
</pre></div>


<p>JELLY_BEAN_MR2（API 18） 相关片段</p>
<div class="highlight"><pre>                <span class="k">case</span> <span class="sc">&#39;K&#39;</span><span class="o">:</span> <span class="c1">// hour in am/pm (0-11)</span>
                <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span> <span class="c1">// hour in am/pm (1-12)</span>
                    <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">hour</span> <span class="o">=</span> <span class="n">inDate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">HOUR</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">hour</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">replacement</span> <span class="o">=</span> <span class="n">zeroPad</span><span class="o">(</span><span class="n">hour</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="sc">&#39;H&#39;</span><span class="o">:</span> <span class="c1">// hour in day (0-23)</span>
                <span class="k">case</span> <span class="sc">&#39;k&#39;</span><span class="o">:</span> <span class="c1">// hour in day (1-24) [but see note below]</span>
                    <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">hour</span> <span class="o">=</span> <span class="n">inDate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">HOUR_OF_DAY</span><span class="o">);</span>
                        <span class="c1">// Historically on Android &#39;k&#39; was interpreted as &#39;H&#39;, which wasn&#39;t</span>
                        <span class="c1">// implemented, so pretty much all callers that want to format 24-hour</span>
                        <span class="c1">// times are abusing &#39;k&#39;. http://b/8359981.</span>
                        <span class="k">if</span> <span class="o">(</span><span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;k&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">hour</span> <span class="o">=</span> <span class="mi">24</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">replacement</span> <span class="o">=</span> <span class="n">zeroPad</span><span class="o">(</span><span class="n">hour</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
</pre></div>


<p>由此可见关于小时 JELLY_BEAN_MR2（API 18） 以前是只能解析 h 与 k，其中</p>
<div class="highlight"><pre><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span><span class="o">-</span><span class="mi">12</span>
<span class="n">k</span> <span class="o">:</span> <span class="mi">0</span><span class="o">-</span><span class="mi">23</span>
</pre></div>


<p>对于 JELLY_BEAN_MR2（API 18） 及以后的本版可以解析h，H，k，K，其中</p>
<div class="highlight"><pre><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span><span class="o">-</span><span class="mi">12</span>
<span class="n">H</span> <span class="o">:</span> <span class="mi">0</span><span class="o">-</span><span class="mi">23</span>
<span class="n">k</span> <span class="o">:</span> <span class="mi">1</span><span class="o">-</span><span class="mi">24</span>
<span class="n">K</span> <span class="o">:</span> <span class="mi">0</span><span class="o">-</span><span class="mi">11</span>
</pre></div>


<p>为啥要改成这个样子呢？大概是因为 <code>java.text.SimpleDateFormat</code> 也是这个样子吧，具体可以看<a href="http://docs.oracle.com/javase/6/docs/api/java/text/SimpleDateFormat.html">这里</a>。unicode 也有一样的<a href="http://www.unicode.org/reports/tr35/tr35-dates.html#Date_Format_Patterns">标准</a>。</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'seven332';
        var disqus_identifier = 'android-dateformat-guan-yu-xiao-shi-de-jie-xi.html';
        var disqus_url = 'http://seven332.github.io/android-dateformat-guan-yu-xiao-shi-de-jie-xi.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//seven332.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>友情链接</h2>
                        <ul>
                            <li><a href="#">无</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>社交</h2>
                        <ul>

                            <li><a href="#">无</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                自豪地采用 <a href="http://getpelican.com/">Pelican</a>，多谢 <a href="http://python.org">Python</a>
                </address><!-- /#about -->

                <p>该主题修改自 <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">notmyidea</a></p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'seven332';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>
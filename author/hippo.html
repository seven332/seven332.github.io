<!DOCTYPE html>
<html lang=zh> <head><meta charset=utf-8><title>Hippo's Blog - Hippo</title><link rel=stylesheet href=http://seven332.github.io/theme/css/main.css><link href=http://seven332.github.io/feeds/all.rss.xml type=application/rss+xml rel=alternate title="Hippo's Blog RSS Feed"><!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]--></head> <body id=index class=home> <header id=banner class=body> <h1><a href=http://seven332.github.io/ >Hippo's Blog </a></h1> <nav><ul> <li><a href=http://seven332.github.io/category/android.html>Android</a></li> <li><a href=http://seven332.github.io/category/cc.html>C/C++</a></li> <li><a href=http://seven332.github.io/category/wu.html>无</a></li> </ul></nav> </header><!-- /#banner --> <aside id=featured class=body> <article> <h1 class=entry-title><a href=http://seven332.github.io/yi-zhi-7-zip-jbinding-dao-android.html>移植 7-Zip-JBinding 到 Android</a></h1> <footer class=post-info> <abbr class=published title=2016-05-25T19:04:00+08:00> 发表于：16-05-25 19 Wed </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --><p>近期一直在做 7-Zip-JBinding 到 Android 的移植，目前算是完成了。7-Zip-JBinding 对 7-Zip 的封装完成度很高。不过在移植过程中还是遇到过一些问题。</p> <p>首先是创建 7z 格式压缩文件的时候会出现 native crash。</p> <div class=highlight><pre><span></span>JNI DETECTED ERROR IN APPLICATION: use of invalid jobject 0x7f49b9dd
</pre></div> <p>一般来说，<code>invalid jobject</code> 是 0x00000000，也就是 <code>NULL</code>，不过这里不是，那么就是别的问题。调了下发现是在别的线程里出现的这个问题，那么就应该是没有创建 global references 的问题。加上后就好了。</p> <p>修改后依然有 native crash，调了下发现是有个 <code>jclass</code> 为 <code>NULL</code>。为啥 <code>env-&gt;FindClass</code> 会返回 <code>NULL</code> 呢？明明这个 class 是存在的。查了下发现，在非 java 代码里创建的线程通过 <code>env-&gt;FindClass</code> 只能找到系统自带的 class，因为只用系统的 class loader。那么我就在 java 那边加了 FindClass 的静态函数，使用应用的 class loader 来 <code>loadClass</code>，在要调用 <code>env-&gt;FindClass</code> 的时候就换成调用自己加的 FindClass。这样问题就解决了。</p> <p>现在基本的压缩和解压都能用了。为了稳妥还是移植下 7-Zip-JBinding 里的 test。遇到的第一个问题就是测试文件的读取。要在 Android 平台上测试就要把测试文件放到 Android 的文件系统里，而 Android API 23 加了个动态权限申请，测试的时候又没办法手动点确定。所以需要把测试文件放到无需申请权限的空间。比较好的方法是把测试文件放到 assets 里，在跑测试前把 assets 里的测试文件拷贝出来。这个时候让人很不愉快的事情发生了，aapt 会自动解压 gz 文件。<strong>我还没测试你就解压，我还个测试什么呢？</strong>只好把所有测试文件打个包，到时候再解压。然后改下测试文件的路径就好了。</p> <p>测试开始跑了，不一会儿就出现问题了。</p> <div class=highlight><pre><span></span>JNI ERROR (app bug): local reference table overflow (max=512)
</pre></div> <p>正如错误本身所说，本地引用表溢出了，想必是缺 <code>DeleteLocalRef</code> 了，那么就加上些吧。该加的地方还不少，顺便还发现了些缺 <code>ReleaseStringUTFChars</code> 的地方。</p> <p>还有个问题着实然后头疼了一阵，就是这个。</p> <div class=highlight><pre><span></span>JNI DETECTED ERROR IN APPLICATION: the return type of CallObjectMethodV does not match net.sf.sevenzipjbinding.IOutItemBase net.sf.sevenzipjbinding.IOutCreateCallback.getItemInformation(int, net.sf.sevenzipjbinding.impl.OutItemFactory)
</pre></div> <p>这个错误是自相矛盾啊，返回值类型没问题呀。仔细看了下 java 那边的代码，感觉是 <code>java.reflect.Proxy</code> 有问题，取消掉后就好了。猜测不能再 jni 里调用 <code>java.reflect.Proxy</code>。</p> <p>遇到的有价值的问题大概就这些。</p> <ul> <li><a href=https://developer.android.com/training/articles/perf-jni.html>https://developer.android.com/training/articles/perf-jni.html</a></li> <li><a href=http://android-developers.blogspot.com/2011/11/jni-local-reference-changes-in-ics.html>http://android-developers.blogspot.com/2011/11/jni-local-reference-changes-in-ics.html</a></li> </ul><p><a href=http://seven332.github.io/yi-zhi-7-zip-jbinding-dao-android.html#disqus_thread>来看评论</a></p> </article> </aside><!-- /#featured --> <section id=content class=body> <h1>其他文章</h1> <hr> <ol id=posts-list class=hfeed> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/unsatisfiedlinkerror-dlopen-failed-has-text-relocations.html rel=bookmark title="Permalink to UnsatisfiedLinkError: dlopen failed: has text relocations">UnsatisfiedLinkError: dlopen failed: has text relocations</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2016-03-08T22:21:00+08:00> 发表于：16-03-08 22 Tue </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>有人说 Nimingban 在 Android 6.0 下闪退，我感觉很奇怪，因为我用的就是 Android 6.0，而且使用正常。于是我在 Android 6.0 x86 的虚拟机上跑了下，果然闪退了。错误是这样的</p> <div class=highlight><pre><span></span>java.lang.UnsatisfiedLinkError: dlopen failed: xxx.so: has text relocations
</pre></div> <p>搜索了下发现了<a href=http://slowbutdeadly.blogspot.jp/2015/09/javalangunsatisfiedlinkerror-dlopen.html>这个</a>。根据他的描述，使用最新的 NDK 就可以解决这个问题，而我使用就是最新的 NDK，结果还是在 x86 上出了问题。那么应该是平台问题了。</p> <p>看看这个问题，说的是 has text relocations，这个问题似乎在以前的 Android ...</p> <a class=readmore href=http://seven332.github.io/unsatisfiedlinkerror-dlopen-failed-has-text-relocations.html>来看更多</a> <p><a href=http://seven332.github.io/unsatisfiedlinkerror-dlopen-failed-has-text-relocations.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/xiu-zheng-autoconf-zhong-chu-xian-de-cuo-wu.html rel=bookmark title="Permalink to 修正 autoconf 中出现的错误">修正 autoconf 中出现的错误</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2016-02-07T23:34:00+08:00> 发表于：16-02-07 23 Sun </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/cc.html>C/C++</a></p> </footer><!-- /.post-info --> <p>有时跑 autoconf 会出现类似<code>error: possibly undefined macro: XXX</code>的问题。我在<a href=https://bbs.archlinux.org/viewtopic.php?id=161452>这里</a>看到了解决方法。</p> <div class=highlight><pre><span></span>$ libtoolize --force
$ aclocal
$ autoheader
$ automake --force-missing --add-missing
$ autoconf
</pre></div> <p>这样就好了。</p> <a class=readmore href=http://seven332.github.io/xiu-zheng-autoconf-zhong-chu-xian-de-cuo-wu.html>来看更多</a> <p><a href=http://seven332.github.io/xiu-zheng-autoconf-zhong-chu-xian-de-cuo-wu.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/valueanimatorpause-nei-cun-xie-lou.html rel=bookmark title="Permalink to ValueAnimator.pause() 内存泄漏">ValueAnimator.pause() 内存泄漏</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2016-01-18T12:04:00+08:00> 发表于：16-01-18 12 Mon </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>ValueAnimator.pause() 在 API 19 引入，若不正确使用会导致严重内存泄漏。</p> <p>以前有些使用 ValueAnimator.stop() 的地方在 API 19 及以后可以使用 ValueAnimator.pause() 替代来达到更好的效果。但是若在调用 ValueAnimator.pause() 之后就放弃了 ValueAnimator 实例的话，这个 ValueAnimator 实例会一直被 ValueAnimator.AnimationHandler 占有，从而导致内存泄漏。</p> <a class=readmore href=http://seven332.github.io/valueanimatorpause-nei-cun-xie-lou.html>来看更多</a> <p><a href=http://seven332.github.io/valueanimatorpause-nei-cun-xie-lou.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/android-xia-bian-yi-libjpeg-turbo.html rel=bookmark title="Permalink to Android 下编译 libjpeg-turbo">Android 下编译 libjpeg-turbo</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2015-10-21T23:47:00+08:00> 发表于：15-10-21 23 Wed </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>以前就移植过 libjpeg-turbo，这次又下载了最新的源码重新移植了一遍，发现在以前移植过程中有不好的做法，同时也出现了新的问题。</p> <p>源码可以在<a href=https://github.com/seven332/seven332.github.io>这里</a>找到。</p> <p>移植的过程基本就是把 Makefile 转为 Android.mk 的过程，当然其中会出现不少问题。同时所需要的只有解码部分，所以要把编码部分的源码剔除。</p> <p>libjpeg-turbo 与 libjpeg 最大的区别在于 libjpeg-turbo 有不少汇编代码。Android 也是有多个硬件平台，可以与其汇编代码对应起来。具体各个平台需要哪些源码直接看<a href=https://github.com/seven332/libjpeg-turbo/blob/master/Android.mk>这里</a>好了，值得注意的是并不所有的 Android 硬件平台 libjpeg-turbo 都提供了汇编代码，对于那些没有被照顾到的硬件平台就添加 jsimd_none.c 文件。</p> <p>接下来是遇到的问题，x86_64 编译会出现问题</p> <div class=highlight><pre><span></span>***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:50: error: redefinition of ...</pre></div> <a class=readmore href=http://seven332.github.io/android-xia-bian-yi-libjpeg-turbo.html>来看更多</a> <p><a href=http://seven332.github.io/android-xia-bian-yi-libjpeg-turbo.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/resolveactivity-de-zhong-yao-xing.html rel=bookmark title="Permalink to resolveActivity 的重要性">resolveActivity 的重要性</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2015-10-08T21:18:00+08:00> 发表于：15-10-08 21 Thu </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>在 Android Developers 发的视频 <a href=https://www.youtube.com/watch?v=HGElAW224dE>Protecting Implicit Intents with Runtime Checks (Android Development Patterns Ep 1)</a> 中看到了自己以前犯过的一个错误，就是没有处理 Implicit Intents 导致的 ActivityNotFoundException 异常。</p> <p>每当需要用 Implicit Intents 的时候我就会想，用户不可能连这个都没装吧，这是 Android L 的新特性，有系统应用支持肯定不会有问题的。结果都出问题了。可能是用户真的没有安装这类应用，譬如用户用的是模拟器什么类的特殊平台，或者有什么权限的限制。看到错误日志之后，我就直接获取 ActivityNotFoundException，然后忽略。但这并不是一个好的处理方式，因为 ActivityNotFoundException 继承的是 RuntimeException。没有人会不做边界检查直接捕获 IndexOutOfBoundsException。这时候 <a href="http://developer.android.com/reference/android/content/pm/PackageManager.html#resolveActivity(android.content.Intent, int)">resolveActivity</a> 的重要性就体出来了 ...</p> <a class=readmore href=http://seven332.github.io/resolveactivity-de-zhong-yao-xing.html>来看更多</a> <p><a href=http://seven332.github.io/resolveactivity-de-zhong-yao-xing.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/switchpreference-zai-pre-l-xia-de-bug.html rel=bookmark title="Permalink to SwitchPreference 在 pre-L 下的 bug">SwitchPreference 在 pre-L 下的 bug</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2015-09-29T16:15:00+08:00> 发表于：15-09-29 16 Tue </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>在 <a href=https://github.com/seven332/Nimingban>Nimingban</a> 这个应用中，最开始我是把暗色主题用 SwitchPreference 放在设置界面里的，而且是第一项。后来有用户反馈说是把设置往下滑动，会出现界面闪烁。我听后感觉很奇怪，因为我这不能重现这个 bug，而且设置界面这方面的代码我也没有用什么奇技淫巧，想必不太可能是我的锅。既然不是我的锅那么就是系统的锅了。好在这个问题貌似只是几个用户会遇到，我也就没太注意，直接在设置中删掉暗色主题的设置，移到右侧栏的下面，自认为完美地解决了这个问题。</p> <p>后来又看到有用户反馈说随着设置界面的滑动，设置项的值会变化。看来这个问题并没有被解决。想想看肯定还是系统的问题。查询了一番果然是系统的问题，而且 lollipop 以下的都有这个问题。这个问题已经有人在 stackoverflow 上<a href=http://stackoverflow.com/questions/15632215/preference-items-being-automatically-re-set>问了</a>，而且提交了 <a href=https://code.google.com/p/android/issues/detail?id=26194>issue</a>。</p> <p>问题的原因在提交的 issue 里描述的很清楚。PreferenceFragment 用的是 ListView，ListView 会对控件重复使用，问题就出现在重复使用的过程中。</p> <p>kitkat-mr2.2-release (API 19) SwitchPreference 相关片段</p> <div class=highlight><pre><span></span><span class=kd>private ...</span></pre></div> <a class=readmore href=http://seven332.github.io/switchpreference-zai-pre-l-xia-de-bug.html>来看更多</a> <p><a href=http://seven332.github.io/switchpreference-zai-pre-l-xia-de-bug.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/android-dateformat-guan-yu-xiao-shi-de-jie-xi.html rel=bookmark title="Permalink to Android DateFormat 关于小时的解析">Android DateFormat 关于小时的解析</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2015-09-29T15:00:00+08:00> 发表于：15-09-29 15 Tue </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>这是以前写的文章。</p> <p>这是以前遇到的问题，具体可以在<a href=https://github.com/seven332/EhViewer/issues/16>这里</a>看到。今天不想做别的事所以又研究了下。</p> <p>我本来是想弄个显示时间的控件，记得 Android 本身就有个 TextClock 就直接拿过来用了。结果这个是 JELLY_BEAN_MR1（API 17） 的时候加入的。为了兼容旧的 Android 本版，我直接把 TextClock 的代码拷贝了一份修改了下就能用了。</p> <p>后来有看到别人发的截图，时间显示的是 HH:什么什么。我当时没有注意。后来有人发个了 issue，我才开始注意这个问题。</p> <p>JELLY_BEAN_MR1（API 17） TextClock 默认解析格式是</p> <div class=highlight><pre><span></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>CharSequence</span> <span class=n>DEFAULT_FORMAT_12_HOUR</span> <span class=o>=</span> <span class=s>&quot;h:mm aa&quot;</span><span class=o>;</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>CharSequence</span> <span class=n>DEFAULT_FORMAT_24_HOUR</span> <span class=o>=</span> <span class=s>&quot;k ...</span></pre></div> <a class=readmore href=http://seven332.github.io/android-dateformat-guan-yu-xiao-shi-de-jie-xi.html>来看更多</a> <p><a href=http://seven332.github.io/android-dateformat-guan-yu-xiao-shi-de-jie-xi.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> <li><article class=hentry> <header> <h1><a href=http://seven332.github.io/hello-world.html rel=bookmark title="Permalink to Hello World">Hello World</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2015-09-29T14:32:00+08:00> 发表于：15-09-29 14 Tue </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/wu.html>无</a></p> </footer><!-- /.post-info --> <p>还是要写点东西，对自己对其他人都有好处。以前也准备弄个博客，可是代码显示怎么也弄不好。当时用的是 Jekyll，ruby 我也看不懂，一不爽就不弄了。现在用的是 Pelican，python 的话至少还是看的懂的，平时会用她写些小东西。代码显示方面也没怎么配置直接就能用了。</p> <a class=readmore href=http://seven332.github.io/hello-world.html>来看更多</a> <p><a href=http://seven332.github.io/hello-world.html#disqus_thread>来看评论</a></p> </div><!-- /.entry-content --> </article></li> </ol><!-- /#posts-list --> </section><!-- /#content --> <section id=extras class=body> <div class=blogroll> <h2>友情链接</h2> <ul> <li><a href=#>无</a></li> </ul> </div><!-- /.blogroll --> <div class=social> <h2>社交</h2> <ul> <li><a href=http://seven332.github.io/feeds/all.rss.xml type=application/rss+xml rel=alternate>rss feed</a></li> <li><a href=http://github.com/seven332>github</a></li> </ul> </div><!-- /.social --> </section><!-- /#extras --> <footer id=contentinfo class=body> <address id=about class="vcard body"> 自豪地采用 <a href=http://getpelican.com/ >Pelican</a>，多谢 <a href=http://python.org>Python</a> </address><!-- /#about --> <p>该主题修改自 <a href=http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/ >notmyidea</a></p> </footer><!-- /#contentinfo --> <script type=text/javascript>
    var disqus_shortname = 'seven332';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script> </body> </html>
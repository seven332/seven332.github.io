<!DOCTYPE html>
<html lang=zh> <head><meta charset=utf-8><title>Android 下编译 libjpeg-turbo</title><link rel=stylesheet href=http://seven332.github.io/theme/css/main.css><link href=http://seven332.github.io/feeds/all.rss.xml type=application/rss+xml rel=alternate title="Hippo's Blog RSS Feed"><!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]--></head> <body id=index class=home> <header id=banner class=body> <h1><a href=http://seven332.github.io/ >Hippo's Blog </a></h1> <nav><ul> <li class=active><a href=http://seven332.github.io/category/android.html>Android</a></li> <li><a href=http://seven332.github.io/category/cc.html>C/C++</a></li> <li><a href=http://seven332.github.io/category/wu.html>无</a></li> </ul></nav> </header><!-- /#banner --> <section id=content class=body> <article> <header> <h1 class=entry-title> <a href=http://seven332.github.io/android-xia-bian-yi-libjpeg-turbo.html rel=bookmark title="Permalink to Android 下编译 libjpeg-turbo">Android 下编译 libjpeg-turbo</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2015-10-21T23:47:00+08:00> 发表于：15-10-21 23 Wed </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>以前就移植过 libjpeg-turbo，这次又下载了最新的源码重新移植了一遍，发现在以前移植过程中有不好的做法，同时也出现了新的问题。</p> <p>源码可以在<a href=https://github.com/seven332/seven332.github.io>这里</a>找到。</p> <p>移植的过程基本就是把 Makefile 转为 Android.mk 的过程，当然其中会出现不少问题。同时所需要的只有解码部分，所以要把编码部分的源码剔除。</p> <p>libjpeg-turbo 与 libjpeg 最大的区别在于 libjpeg-turbo 有不少汇编代码。Android 也是有多个硬件平台，可以与其汇编代码对应起来。具体各个平台需要哪些源码直接看<a href=https://github.com/seven332/libjpeg-turbo/blob/master/Android.mk>这里</a>好了，值得注意的是并不所有的 Android 硬件平台 libjpeg-turbo 都提供了汇编代码，对于那些没有被照顾到的硬件平台就添加 jsimd_none.c 文件。</p> <p>接下来是遇到的问题，x86_64 编译会出现问题</p> <div class=highlight><pre>***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:50: error: redefinition of `collect_args&#39;
***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:50: error: `collect_args&#39; previously defined here
***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:74: error: redefinition of `collect_args.rowloop&#39;
***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:74: error: `collect_args.rowloop&#39; previously defined here
***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:91: error: redefinition of `collect_args.column_ld1&#39;
***/jni/libjpeg-turbo/simd/jccolext-sse2-64.asm:91: error: `collect_args.column_ld1&#39; previously defined here
...
make.exe: *** [E:/JetBrains/Projects/CLionProjects/Image/libimage/obj/local/x86_64/objs-debug/jpeg-turbo/simd/jccolor-sse2-64.o] Error 1
</pre></div> <p>中间省略了一些，反正是类似的错误。印象中上次移植并没有遇到这个问题，难道是作者更新了源码导致的错误？上次移植用的是 Android NDK r10d，x86_64 还不能自动识别 asm，我只好修改了下 build-binary.mk。我把以前修改 build-binary.mk 的<a href=https://github.com/seven332/EhViewer/blob/dev/README.md>记录</a>翻了出来。与默认的编译命令相比多了 <code>-m amd64 -DELF -D__x86_64__ -DPIC</code>，想必是这些参数使得编译成功。到底是哪个呢，一个个试就知道了。结果是 -D__x86_64__。在 jsimdext.inc 中也可以看到。</p> <p>然后就是链接问题了</p> <div class=highlight><pre>***/jni/libjpeg-turbo/simd/jsimd_x86_64.c:43: error: undefined reference to &#39;jconst_rgb_ycc_convert_sse2&#39;
***/jni/libjpeg-turbo/simd/jsimd_x86_64.c:60: error: undefined reference to &#39;jconst_rgb_gray_convert_sse2&#39;
***/jni/libjpeg-turbo/simd/jsimd_x86_64.c:77: error: undefined reference to &#39;jconst_ycc_rgb_convert_sse2&#39;
***/jni/libjpeg-turbo/simd/jsimd_x86_64.c:98: error: undefined reference to &#39;jsimd_extrgb_ycc_convert_sse2&#39;
...
collect2.exe: error: ld returned 1 exit status
make.exe: *** [E:/JetBrains/Projects/CLionProjects/Image/libimage/obj/local/x86_64/libjpeg-turbo.so] Error 1
</pre></div> <p>这个问题上次就出现过，我直接把 <code>%define EXTN(name) _ %+ name</code> 改成了 <code>%define EXTN(name) name</code>，然而这并不是一个好办法。通过看 jsimdext.inc 的源码可以知道，分明缺的是 ELF 这个宏，所以加上 <code>-DELF</code> 就好了。</p> <p>然后就顺利编译完成了。可是在手机里显示的图像却是错误的。这令我颇不愉快。莫非我的代码写得有问题？我又把代码放到 Windows 上跑一遍，没有问题。那么应该就是 arm 上的汇编代码写得有问题，我又取消了 simd 重新编译，可是在手机上跑还是解码有问题。那么可能是版本问题，我把版本号降到了之前编译的版本 1.4.0，再编译一遍，可以正常解码。换到 1.4.1，解码错误。为何会这样呢？作者没发现这个问题，还是我在移植过程中出了什么错误呢？直接看看 1.4.1 都有啥变动吧。</p> <div class=highlight><pre>git diff 1.4.0 1.4.1
</pre></div> <p>有这么两行</p> <div class=highlight><pre>-#if __WORDSIZE == 64 || defined(_WIN64)
+#if SIZEOF_SIZE_T==8 || defined(_WIN64)
</pre></div> <p>SIZEOF_SIZE_T 这是个宏，是 jconfig.h 里的，<code>#define SIZEOF_SIZE_T 8</code>。jconfig.h 是直接 <code>./configure</code> 跑出来的，PC 系统是 64 位，size_t 大小是 8，而手机系统是 32 位，size_t 大小是 4，所以很可能是这里除了问题。怎么办呢？又不能直接换成 <code>sizeof(size_t)</code>。还是通过判断是 64 位还是 32 位来决定吧，虽然不能保证一定是正确的。看看 gcc 有没有什么特殊的预设宏。查看的方法在<a href=http://nadeausoftware.com/articles/2011/12/c_c_tip_how_list_compiler_predefined_macros>这里</a>，需要注意的是 Windows 下没有 <code>/dev/null</code>，直接换成随便一个文件名。预设宏很多啊，突然看到原来就有 <code>__SIZEOF_SIZE_T__</code> 这个宏。直接就可以改成 <code>#define SIZEOF_SIZE_T __SIZEOF_SIZE_T__</code>。</p> <p>如此一来算是完成了 libjpeg-turbo 到 Android 的移植。不过还可以做些修改让 libjpeg-turbo 在 Android 上运行的更好。</p> <p>首先是 arm 上 neon 的判断，可以直接调用 cpufeatures，具体可参照<a href=https://github.com/seven332/libjpeg-turbo/commit/b1bef0d986397a1ee1019e610f5e9d4c28a316c2>这里</a>。</p> <p>Android L 引入了新的文件机制，有时需要通过这种文件机制来读取图片。而 libjpeg-turbo 仅提供了 FILE* 读取和内存读取两种方法。想要通过 Android 新的文件机制来读取就只能先完全把图片文件读取到内存里。这似乎并不是个好主意，这有些浪费内存的感觉。好的解决方法是添加一种自定义的读取方式，就像 libpng 和 giflib 那样。修改起来也很简单，基本就是在 FILE* 读取方法上稍作修改就好了。具体可参照<a href=https://github.com/seven332/libjpeg-turbo/commit/efa06eed172cf6ae2c394d51e2ea119a329e4d92>这里</a>。</p> </div><!-- /.entry-content --> <div class=comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = 'seven332';
        var disqus_identifier = 'android-xia-bian-yi-libjpeg-turbo.html';
        var disqus_url = 'http://seven332.github.io/android-xia-bian-yi-libjpeg-turbo.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//seven332.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script> <noscript>Please enable JavaScript to view the comments.</noscript> </div> </article> </section> <section id=extras class=body> <div class=blogroll> <h2>友情链接</h2> <ul> <li><a href=#>无</a></li> </ul> </div><!-- /.blogroll --> <div class=social> <h2>社交</h2> <ul> <li><a href=http://seven332.github.io/feeds/all.rss.xml type=application/rss+xml rel=alternate>rss feed</a></li> <li><a href=http://github.com/seven332>github</a></li> </ul> </div><!-- /.social --> </section><!-- /#extras --> <footer id=contentinfo class=body> <address id=about class="vcard body"> 自豪地采用 <a href=http://getpelican.com/ >Pelican</a>，多谢 <a href=http://python.org>Python</a> </address><!-- /#about --> <p>该主题修改自 <a href=http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/ >notmyidea</a></p> </footer><!-- /#contentinfo --> <script type=text/javascript>
    var disqus_shortname = 'seven332';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script> </body> </html>
<!DOCTYPE html>
<html lang=zh> <head><meta charset=utf-8><title>移植 7-Zip-JBinding 到 Android</title><link rel=stylesheet href=http://seven332.github.io/theme/css/main.css><link href=http://seven332.github.io/feeds/all.rss.xml type=application/rss+xml rel=alternate title="Hippo's Blog RSS Feed"><!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]--></head> <body id=index class=home> <header id=banner class=body> <h1><a href=http://seven332.github.io/ >Hippo's Blog </a></h1> <nav><ul> <li><a href=http://seven332.github.io/category/algorithm.html>Algorithm</a></li> <li class=active><a href=http://seven332.github.io/category/android.html>Android</a></li> <li><a href=http://seven332.github.io/category/cc.html>C/C++</a></li> <li><a href=http://seven332.github.io/category/java.html>Java</a></li> <li><a href=http://seven332.github.io/category/wu.html>无</a></li> </ul></nav> </header><!-- /#banner --> <section id=content class=body> <article> <header> <h1 class=entry-title> <a href=http://seven332.github.io/yi-zhi-7-zip-jbinding-dao-android.html rel=bookmark title="Permalink to 移植 7-Zip-JBinding 到 Android">移植 7-Zip-JBinding 到 Android</a></h1> </header> <div class=entry-content> <footer class=post-info> <abbr class=published title=2016-05-25T19:04:00+08:00> 发表于：16-05-25 19 周三 </abbr> <p> 作者： <a class="url fn" href=http://seven332.github.io/author/hippo.html>Hippo</a> </p> <p>分类： <a href=http://seven332.github.io/category/android.html>Android</a></p> </footer><!-- /.post-info --> <p>近期一直在做 7-Zip-JBinding 到 Android 的移植，目前算是完成了。7-Zip-JBinding 对 7-Zip 的封装完成度很高。不过在移植过程中还是遇到过一些问题。</p> <p>首先是创建 7z 格式压缩文件的时候会出现 native crash。</p> <div class=highlight><pre><span></span>JNI DETECTED ERROR IN APPLICATION: use of invalid jobject 0x7f49b9dd
</pre></div> <p>一般来说，<code>invalid jobject</code> 是 0x00000000，也就是 <code>NULL</code>，不过这里不是，那么就是别的问题。调了下发现是在别的线程里出现的这个问题，那么就应该是没有创建 global references 的问题。加上后就好了。</p> <p>修改后依然有 native crash，调了下发现是有个 <code>jclass</code> 为 <code>NULL</code>。为啥 <code>env-&gt;FindClass</code> 会返回 <code>NULL</code> 呢？明明这个 class 是存在的。查了下发现，在非 java 代码里创建的线程通过 <code>env-&gt;FindClass</code> 只能找到系统自带的 class，因为只用系统的 class loader。那么我就在 java 那边加了 FindClass 的静态函数，使用应用的 class loader 来 <code>loadClass</code>，在要调用 <code>env-&gt;FindClass</code> 的时候就换成调用自己加的 FindClass。这样问题就解决了。</p> <p>现在基本的压缩和解压都能用了。为了稳妥还是移植下 7-Zip-JBinding 里的 test。遇到的第一个问题就是测试文件的读取。要在 Android 平台上测试就要把测试文件放到 Android 的文件系统里，而 Android API 23 加了个动态权限申请，测试的时候又没办法手动点确定。所以需要把测试文件放到无需申请权限的空间。比较好的方法是把测试文件放到 assets 里，在跑测试前把 assets 里的测试文件拷贝出来。这个时候让人很不愉快的事情发生了，aapt 会自动解压 gz 文件。<strong>我还没测试你就解压，我还个测试什么呢？</strong>只好把所有测试文件打个包，到时候再解压。然后改下测试文件的路径就好了。</p> <p>测试开始跑了，不一会儿就出现问题了。</p> <div class=highlight><pre><span></span>JNI ERROR (app bug): local reference table overflow (max=512)
</pre></div> <p>正如错误本身所说，本地引用表溢出了，想必是缺 <code>DeleteLocalRef</code> 了，那么就加上些吧。该加的地方还不少，顺便还发现了些缺 <code>ReleaseStringUTFChars</code> 的地方。</p> <p>还有个问题着实然后头疼了一阵，就是这个。</p> <div class=highlight><pre><span></span>JNI DETECTED ERROR IN APPLICATION: the return type of CallObjectMethodV does not match net.sf.sevenzipjbinding.IOutItemBase net.sf.sevenzipjbinding.IOutCreateCallback.getItemInformation(int, net.sf.sevenzipjbinding.impl.OutItemFactory)
</pre></div> <p>这个错误是自相矛盾啊，返回值类型没问题呀。仔细看了下 java 那边的代码，感觉是 <code>java.reflect.Proxy</code> 有问题，取消掉后就好了。猜测不能再 jni 里调用 <code>java.reflect.Proxy</code>。</p> <p>遇到的有价值的问题大概就这些。</p> <ul> <li><a href=https://developer.android.com/training/articles/perf-jni.html>https://developer.android.com/training/articles/perf-jni.html</a></li> <li><a href=http://android-developers.blogspot.com/2011/11/jni-local-reference-changes-in-ics.html>http://android-developers.blogspot.com/2011/11/jni-local-reference-changes-in-ics.html</a></li> </ul> </div><!-- /.entry-content --> <div class=comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = 'seven332';
        var disqus_identifier = 'yi-zhi-7-zip-jbinding-dao-android.html';
        var disqus_url = 'http://seven332.github.io/yi-zhi-7-zip-jbinding-dao-android.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//seven332.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script> <noscript>Please enable JavaScript to view the comments.</noscript> </div> </article> </section> <section id=extras class=body> <div class=blogroll> <h2>友情链接</h2> <ul> <li><a href=#>无</a></li> </ul> </div><!-- /.blogroll --> <div class=social> <h2>社交</h2> <ul> <li><a href=http://seven332.github.io/feeds/all.rss.xml type=application/rss+xml rel=alternate>rss feed</a></li> <li><a href=http://github.com/seven332>github</a></li> </ul> </div><!-- /.social --> </section><!-- /#extras --> <footer id=contentinfo class=body> <address id=about class="vcard body"> 自豪地采用 <a href=http://getpelican.com/ >Pelican</a>，多谢 <a href=http://python.org>Python</a> </address><!-- /#about --> <p>该主题修改自 <a href=http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/ >notmyidea</a></p> </footer><!-- /#contentinfo --> <script type=text/javascript>
    var disqus_shortname = 'seven332';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script> </body> </html>